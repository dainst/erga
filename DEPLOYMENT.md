# Erga Deployment

All commands run from the repository root.

## Deploying a new version

* Pull commit/release/branch you want to update to.
* Run build: `docker-compose -f docker-compose.release.yml build`.
* Check for changes to the .env/.env_template since the last deployment, adjust accordingly them accordingly.
* Recreate the containers: `docker-compose -f docker-compose.release.yml down -v && docker-compose -f docker-compose.release.yml up -d`
* Run migrations `docker exec erga_app /app/bin/erga eval "Erga.Release.migrate"`

## First time setup

### Prerequisites
* Docker/docker-compose

### 1. Checkout repository on VM
### 2. Create .env file

Run
```bash
cp .env_template .env
```

* Adjust the HOST variable for your VM (for example projects.test.dainst.org).
* SECRET_KEY_BASE can be generated by running `mix phx.gen.secret` on a development machine, see: https://hexdocs.pm/phoenix/deployment.html#handling-of-your-application-secrets
* Database name and password can be chosen freely. The only exception: You want to import a database dump (see below). In that case use the same database name.

### 3. Create a acme.json file for traefik

Run
```bash
sudo touch acme.json && sudo chmod 600 acme.json
```

### 4. Setup database

If you want to create an empty database, run the following commands
```bash
docker-compose -f docker-compose.release.yml up -d
docker exec erga_app /app/bin/erga eval "Erga.Release.migrate"
docker exec erga_app /app/bin/erga eval 'Erga.Release.add_user("<email>", "<password>")'
```

Otherwise, if you want to use an existing database dump:
* Copy the existing /uploads directory for the dump into the repository
* Update the docker-compose.release.yml to mount the dump file into the postgres image (see comments in file).

Then run
```bash
docker-compose -f docker-compose.release.yml up -d
```

You have to set the /upload directory user privileges to enable Erga to write to the directory.
```bash
docker exec erga_app id 
```

Which should yield the container's uid. Accordingly run
```bash
chown -R <id> uploads/
```